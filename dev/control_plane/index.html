<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Control Plane Design · Discorder.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Discorder.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">User guide</a></li><li><a class="tocitem" href="../api/">Reference</a></li><li><span class="tocitem">Developer Docs</span><ul><li><a class="tocitem" href="../dev_guide/">Dev Guide</a></li><li class="is-active"><a class="tocitem" href>Control Plane Design</a><ul class="internal"><li><a class="tocitem" href="#Quick-run"><span>Quick run</span></a></li><li><a class="tocitem" href="#Operating-the-control-plane"><span>Operating the control plane</span></a></li><li><a class="tocitem" href="#Monitoring"><span>Monitoring</span></a></li><li><a class="tocitem" href="#Adding-publishers"><span>Adding publishers</span></a></li><li><a class="tocitem" href="#Auto-recovery-from-task-failures"><span>Auto-recovery from task failures</span></a></li><li><a class="tocitem" href="#Shutting-down-the-control-plane"><span>Shutting down the control plane</span></a></li></ul></li><li><a class="tocitem" href="../ideas/">Ideas</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Developer Docs</a></li><li class="is-active"><a href>Control Plane Design</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Control Plane Design</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/tk3369/Discorder.jl/blob/master/docs/src/control_plane.md#L" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Control-Plane"><a class="docs-heading-anchor" href="#Control-Plane">Control Plane</a><a id="Control-Plane-1"></a><a class="docs-heading-anchor-permalink" href="#Control-Plane" title="Permalink"></a></h1><p>The control plane is a critical design component that powers the gateway interface. It maintains the state of the various async processes that interacts with Discord and provides an easy-to-use API to manage the lifecyle of these processes.</p><p>The gateway interface is implemented as multiple concurrent async processes:</p><ol><li><p><strong>Heartbeat</strong> task is an infinite loop that keeps sending heartbeat messages to the Discord server as part fo the gateway protocol. The elapsed time between each heartbeat is determined by an elapsed time value suggested by Discord server with a random jitter.</p></li><li><p><strong>Processor</strong> task is an infinite loop that listens to messages coming from the gateway via a websocket connection. Messages include heartbeat acknowledgement messages as well as all other gateway events.</p></li><li><p><strong>Doctor</strong> task is an infinite loop that monitors the health of heartbeat and processor tasks. If any of those tasks are broken then it will attempt to shut down both tasks and the control plane will restart everything automatically.</p></li><li><p><strong>Master</strong> task is the one that starts Heartbeat, Processor, and Doctor tasks. It just waits until those tasks to finish.</p></li></ol><p>The control plane normally runs in a loop. Suppose that the websocket connection got dropped for some reasons. The Doctor task detects the problem and decided that the system is not healthy. So, all tasks are shut down and the Master task also finishes. Then, the control plane starts everything all over again with a brand new connection to Discord. This design is intentionally made simple – rather than attempting to recover individual failing components, it just restarts the entire thing.</p><p>The <code>fail_on_error</code> flag is a special configuration parameter that changes the behavior of this loop. Rather than trying to recover from failures and restart everything, the control plane just exits when an exception is thrown. This is more useful during development rather than in a production setting. For that reason, the flag is only enabled in the sample <code>dev.toml</code> config but not <code>prod.toml</code>.</p><h2 id="Quick-run"><a class="docs-heading-anchor" href="#Quick-run">Quick run</a><a id="Quick-run-1"></a><a class="docs-heading-anchor-permalink" href="#Quick-run" title="Permalink"></a></h2><p>To run the control plane, make sure that the <code>DISCORD_BOT_TOKEN</code> environment variable is set.</p><p>Then, simply invoke the following function:</p><pre><code class="language-julia hljs">serve()</code></pre><h2 id="Operating-the-control-plane"><a class="docs-heading-anchor" href="#Operating-the-control-plane">Operating the control plane</a><a id="Operating-the-control-plane-1"></a><a class="docs-heading-anchor-permalink" href="#Operating-the-control-plane" title="Permalink"></a></h2><p>The <code>serve</code> function actually takes a couple of keyword parameters if you want more customization:</p><ol><li><code>client</code>: a BotClient object</li><li><code>tracker_ref</code>: a <code>Ref</code> that will be populated in with a <code>GatewayTracker</code> object when the control plane starts can start successfully.</li><li><code>config_file_path</code>: file path of the configuration file such as <code>dev.toml</code> or <code>prod.toml</code>. See <code>etc/</code> directory for sample configurations.</li></ol><p>After the control plane starts successfully, the <code>GatewayTracker</code> object represents the current state, including references to all tasks mentioned above.  Here&#39;s how to test from REPL:</p><pre><code class="language-julia hljs">julia&gt; D = Discorder
Discorder

julia&gt; tracker_ref = Ref{D.GatewayTracker}()
Base.RefValue{Discorder.GatewayTracker}(#undef)

julia&gt; client = D.BotClient()
BotClient(&lt;token&gt;, Discorder.RateLimiter(Dict{String, Discorder.Bucket}(), Dict{String, String}(), Discorder.WAIT))

julia&gt; @async D.serve(; client, tracker_ref, config_file_path = &quot;etc/dev.toml&quot;)
Task (runnable) @0x00000001092088b0</code></pre><p>At this point, the log file should be filled with events data. Check the log file <code>dev.log</code>.</p><h2 id="Monitoring"><a class="docs-heading-anchor" href="#Monitoring">Monitoring</a><a id="Monitoring-1"></a><a class="docs-heading-anchor-permalink" href="#Monitoring" title="Permalink"></a></h2><p>From the REPL, you can see what&#39;s going on with the control plane:</p><pre><code class="language-julia hljs">julia&gt; tracker_ref
Base.RefValue{Discorder.GatewayTracker}(Discorder.GatewayTracker
  websocket: HTTP.WebSockets.WebSocket{HTTP.ConnectionPool.Transaction{MbedTLS.SSLContext}}
  heartbeat_interval_ms: Int64 41250
  seq: Int64 3
  heartbeat_task: Task
  processor_task: Task
  master_task: Task
  doctor_task: Task
  terminate_flag: Bool false
  fail_on_error: Bool true
  config: Dict{String, Any}
  stats: Discorder.GatewayStats
  publishers: Array{Discorder.AbstractEventPublisher}((0,))
)</code></pre><p>To check if the control plane is healthy, use the <code>is_operational</code> function:</p><pre><code class="language-julia hljs">julia&gt; D.is_operational(tracker_ref[])
true</code></pre><p>You can also see some server statistics:</p><pre><code class="language-julia hljs">julia&gt; tracker_ref[].stats
Discorder.GatewayStats
  start_time: TimeZones.ZonedDateTime
  ready_time: TimeZones.ZonedDateTime
  event_count: Int64 23
  published_event_count: Int64 9
  heartbeat_sent_count: Int64 14
  heartbeat_received_count: Int64 14</code></pre><h2 id="Adding-publishers"><a class="docs-heading-anchor" href="#Adding-publishers">Adding publishers</a><a id="Adding-publishers-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-publishers" title="Permalink"></a></h2><p>By default, the control plane works as a ZMQ publisher. It binds to a default port (6000). If additional event publishing is required then you can add new publishers manually. For demo purpose, there are a few publishers in the <code>src/publishers</code> directory:</p><ul><li><code>ChannelEventPublisher</code>: publish events to a <code>Channel</code></li><li><code>DelimitedFileEventPublisher</code>: publish events to a delimited file</li></ul><p>Publishers should generally &quot;fire-and-forget&quot;. However, please beware that if you use <code>ChannelEventPublisher</code>, then there is a possibility that the channel is full and you are blocked due to &quot;back-pressure&quot;. Keep that in mind for production usage as it could hang your control plane.</p><h2 id="Auto-recovery-from-task-failures"><a class="docs-heading-anchor" href="#Auto-recovery-from-task-failures">Auto-recovery from task failures</a><a id="Auto-recovery-from-task-failures-1"></a><a class="docs-heading-anchor-permalink" href="#Auto-recovery-from-task-failures" title="Permalink"></a></h2><p>The control plane can auto-recover after connectivity problems. Let&#39;s simulate such a problem with the processor task in the REPL:</p><pre><code class="language-julia hljs">julia&gt; @async Base.throwto(tracker_ref[].processor_task, ErrorException(&quot;simulated failure&quot;))
Task (runnable) @0x000000016572a290</code></pre><p>In the log file, you will find that the control plane has detected the failure and restarted itself:</p><pre><code class="nohighlight hljs">┌ Info: Starting a new control plane
│   current_time = 2022-09-11T16:36:47.443-07:00
└ @ Discorder /Users/tomkwong/.julia/dev/Discorder/src/gateway.jl:160</code></pre><h2 id="Shutting-down-the-control-plane"><a class="docs-heading-anchor" href="#Shutting-down-the-control-plane">Shutting down the control plane</a><a id="Shutting-down-the-control-plane-1"></a><a class="docs-heading-anchor-permalink" href="#Shutting-down-the-control-plane" title="Permalink"></a></h2><p>The <code>shutdown</code> function can be used to shut down the control plane gracefully.</p><pre><code class="language-julia hljs">julia&gt; D.shutdown(tracker_ref[])</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../dev_guide/">« Dev Guide</a><a class="docs-footer-nextpage" href="../ideas/">Ideas »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Wednesday 9 August 2023 03:54">Wednesday 9 August 2023</span>. Using Julia version 1.9.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
