<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Control Plane · Discorder.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Discorder.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Control Plane</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Control Plane</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/tk3369/Discorder.jl/blob/master/docs/src/control_plane.md#L" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Control-Plane"><a class="docs-heading-anchor" href="#Control-Plane">Control Plane</a><a id="Control-Plane-1"></a><a class="docs-heading-anchor-permalink" href="#Control-Plane" title="Permalink"></a></h1><p>The control plane is a critical design component that powers the gateway interface. It maintains the state of the various async processes that interacts with Discord and provides an easy-to-use API to manage the lifecyle of these processes.</p><p>The gateway interface is implemented as multiple concurrent async processes:</p><ol><li><p><strong>Heartbeat</strong> task is an infinite loop that keeps sending heartbeat messages to the Discord server as part fo the gateway protocol. The elapsed time between each heartbeat is determined by an elapsed time value suggested by Discord server with a random jitter.</p></li><li><p><strong>Processor</strong> task is an infinite loop that listens to messages coming from the gateway via a websocket connection. Messages include heartbeat acknowledgement messages as well as all other gateway events.</p></li><li><p><strong>Doctor</strong> task is an infinite loop that monitors the health of heartbeat and processor tasks. If any of those tasks are broken then it will attempt to shut down both tasks and the control plane will restart everything automatically.</p></li><li><p><strong>Master</strong> task is the one that starts Heartbeat, Processor, and Doctor tasks. It just waits until those tasks to finish.</p></li></ol><p>The control plane normally runs in a loop. Suppose that the websocket connection got dropped for some reasons. The Doctor task detects the problem and decided that the system is not healthy. So, all tasks are shut down and the Master task also finishes. Then, the control plane starts everything all over again with a brand new connection to Discord. This design is intentionally made simple – rather than attempting to recover individual failing components, it just restarts the entire thing.</p><p>The <code>fail_on_error</code> flag is a special configuration parameter that changes the behavior of this loop. Rather than trying to recover from failures and restart everything, the control plane just exits when an exception is thrown. This is more useful during development rather than in a production setting. For that reason, the flag is only enabled in the sample <code>dev.toml</code> config but not <code>prod.toml</code>.</p><h2 id="API"><a class="docs-heading-anchor" href="#API">API</a><a id="API-1"></a><a class="docs-heading-anchor-permalink" href="#API" title="Permalink"></a></h2><p>To run the control plane, make sure that the <code>DISCORD_BOT_TOKEN</code> environment variable is set.</p><p>Then, simply invoke the following function:</p><pre><code class="language-julia hljs">serve()</code></pre><p>The function actually takes a couple of keyword parameters if you want more customization:</p><ol><li><code>client</code>: a BotClient object</li><li><code>tracker_ref</code>: a <code>Ref</code> that will be populated in with a <code>GatewayTracker</code> object when the control plane starts can start successfully.</li><li><code>config_file_path</code>: file path of the configuration file such as <code>dev.toml</code> or <code>prod.toml</code>. See <code>etc/</code> directory for sample configurations.</li></ol><p>After the control plane starts successfully, the <code>GatewayTracker</code> object represents the current state, including references to all tasks mentioned above.  Here&#39;s how to test from REPL:</p><pre><code class="language-julia hljs">julia&gt; D = Discorder
Discorder

julia&gt; tracker_ref = Ref{D.GatewayTracker}()
Base.RefValue{Discorder.GatewayTracker}(#undef)

julia&gt; client = D.BotClient()
BotClient(&lt;token&gt;, Discorder.RateLimiter(Dict{String, Discorder.Bucket}(), Dict{String, String}(), Discorder.WAIT))

julia&gt; @async D.serve(; client, tracker_ref, config_file_path = &quot;etc/dev.toml&quot;)
Task (runnable) @0x00000001092088b0</code></pre><p>At this point, the log file should be filled with events data. Check <code>Discorder.log</code>.</p><p>From the REPL, you can see what&#39;s going on with the control plane:</p><pre><code class="language-julia hljs">julia&gt; tracker_ref
Base.RefValue{Discorder.GatewayTracker}(Discorder.GatewayTracker
  websocket: HTTP.WebSockets.WebSocket{HTTP.ConnectionPool.Transaction{MbedTLS.SSLContext}}
  heartbeat_interval_ms: Int64 41250
  seq: Int64 3
  heartbeat_task: Task
  processor_task: Task
  master_task: Task
  doctor_task: Task
  terminate_flag: Bool false
  fail_on_error: Bool true
  config: Dict{String, Any}
  stats: Discorder.GatewayStats
  publishers: Array{Discorder.AbstractEventPublisher}((0,))
)</code></pre><p>To check if the control plane is healthy, use the <code>is_operational</code> function:</p><pre><code class="language-julia hljs">julia&gt; D.is_operational(tracker_ref[])
true</code></pre><p>You can also see some server statistics:</p><pre><code class="language-julia hljs">julia&gt; tracker_ref[].stats
Discorder.GatewayStats
  start_time: TimeZones.ZonedDateTime
  ready_time: TimeZones.ZonedDateTime
  event_count: Int64 23
  published_event_count: Int64 9
  heartbeat_sent_count: Int64 14
  heartbeat_received_count: Int64 14</code></pre><p>Notice there there are no publishers registered to the server. That means none of the gateway events are communicated to anyone. There are several publisher implementations in this package. See the <code>publishers</code> directory. For demo purpose, let&#39;s add a ZMQ publisher:</p><pre><code class="language-julia hljs">julia&gt; D.add_event_publisher(tracker_ref[], D.ZMQPublisher(6000))</code></pre><p>Then, start a subscriber from the REPL:</p><pre><code class="language-julia hljs">julia&gt; using Sockets, ZMQ

julia&gt; begin
           socket = Socket(SUB)
           subscribe(socket, &quot;&quot;)
           connect(socket, &quot;tcp://localhost:6000&quot;)
           while true
               msg = ZMQ.recv(socket) |&gt; String
               @info &quot;Received&quot; msg
           end
       end</code></pre><p>Now, go to Discord and enter a text message. I just entered &quot;hello&quot;. The ZMQ subscriber now displays the following:</p><pre><code class="nohighlight hljs">┌ Info: Received
└   msg = &quot;MESSAGE_CREATE\t2022-09-11T16:17:41.535-07:00\t{\&quot;member\&quot;:{\&quot;avatar\&quot;:null,\&quot;nick\&quot;:null,\&quot;communication_disabled_until\&quot;:null,\&quot;premium_since\&quot;:null,\&quot;joined_at\&quot;:\&quot;2022-02-10T07:40:03.886+00:00\&quot;,\&quot;roles\&quot;:[\&quot;980718892966088764\&quot;],\&quot;deaf\&quot;:false,\&quot;pending\&quot;:false,\&quot;mute\&quot;:false},\&quot;nonce\&quot;:\&quot;1018661642344333312\&quot;,\&quot;timestamp\&quot;:\&quot;2022-09-11T23:17:41.507+00:00\&quot;,\&quot;embeds\&quot;:[],\&quot;channel_id\&quot;:\&quot;941237066015068163\&quot;,\&quot;mention_everyone\&quot;:false,\&quot;edited_timestamp\&quot;:null,\&quot;author\&quot;:{\&quot;avatar\&quot;:\&quot;e99d41549a0f64ff8e7f02fa146d27b8\&quot;,\&quot;id\&quot;:\&quot;549374980488560651\&quot;,\&quot;discriminator\&quot;:\&quot;8593\&quot;,\&quot;public_flags\&quot;:0,\&quot;username\&quot;:\&quot;tk3369\&quot;},\&quot;guild_id\&quot;:\&quot;941237066015068160\&quot;,\&quot;tts\&quot;:false,\&quot;mentions\&quot;:[],\&quot;pinned\&quot;:false,\&quot;id\&quot;:\&quot;1018661642990526504\&quot;,\&quot;type\&quot;:0,\&quot;content\&quot;:\&quot;hello\&quot;,\&quot;mention_roles\&quot;:[],\&quot;attachments\&quot;:[]}&quot;</code></pre><p>The wire format contains a tab-delimited string with three components:</p><ol><li>Event type e.g. <code>MESSAGE_CREATE</code></li><li>Timestamp e.g. <code>2022-09-11T16:17:41.535-07:00</code></li><li>JSON payload</li></ol><p>The other publishers implementations are as follows:</p><ul><li><code>ChannelEventPublisher</code>: publish events to a <code>Channel</code></li><li><code>DelimitedFileEventPublisher</code>: publish events to a delimited file</li></ul><p>Publishers should generally &quot;fire-and-forget&quot;. However, please beware that if you use <code>ChannelEventPublisher</code>, then there is a possibility that the channel is full and you are blocked due to &quot;back-pressure&quot;. For production usage, you can consider implemented your own non-blocking publisher (or contribute one to this package).</p><p>The control plane can auto-recover after connectivity problems. Let&#39;s simulate such a problem with the processor task in the REPL:</p><pre><code class="language-julia hljs">julia&gt; @async Base.throwto(tracker_ref[].processor_task, ErrorException(&quot;simulated failure&quot;))
Task (runnable) @0x000000016572a290</code></pre><p>Checking the log file, you will find:</p><pre><code class="nohighlight hljs">┌ Error: Processor loop error
│   ex = ErrorException(&quot;simulated failure&quot;)
│   current_time = 2022-09-11T16:36:45.365-07:00
└ @ Discorder /Users/tomkwong/.julia/dev/Discorder/src/gateway.jl:381

┌ Info: Gateway is not healthy, stopping control plane
│   tracker = Discorder.GatewayTracker
│   current_time = 2022-09-11T16:36:45.960-07:00
└ @ Discorder /Users/tomkwong/.julia/dev/Discorder/src/gateway.jl:251

┌ Info: Stopping task
│   task_field = processor_task
│   task = Task (done) @0x0000000174f71cd0
│   reason = auto recovery
│   current_time = 2022-09-11T16:36:46.040-07:00
└ @ Discorder /Users/tomkwong/.julia/dev/Discorder/src/gateway.jl:405
┌ Info: Stopped task successfully
│   task_field = processor_task
│   task = Task (done) @0x0000000174f71cd0
│   current_time = 2022-09-11T16:36:46.119-07:00
└ @ Discorder /Users/tomkwong/.julia/dev/Discorder/src/gateway.jl:415
┌ Info: Stopping task
│   task_field = heartbeat_task
│   task = Task (runnable) @0x0000000174f71b60
│   reason = auto recovery
│   current_time = 2022-09-11T16:36:46.165-07:00
└ @ Discorder /Users/tomkwong/.julia/dev/Discorder/src/gateway.jl:405
┌ Info: Heartbeat task stopped by control plane
│   current_time = 2022-09-11T16:36:46.167-07:00
└ @ Discorder /Users/tomkwong/.julia/dev/Discorder/src/gateway.jl:304
┌ Warning: Task already be set to nothing by control plane doctor?
│   task = nothing
│   label = processor
│   current_time = 2022-09-11T16:36:46.208-07:00
└ @ Discorder /Users/tomkwong/.julia/dev/Discorder/src/gateway.jl:640
┌ Info: Finished master task
│   current_time = 2022-09-11T16:36:46.307-07:00
└ @ Discorder /Users/tomkwong/.julia/dev/Discorder/src/gateway.jl:219
┌ Debug: Ensuring task is stopped
│   task_field = heartbeat_task
│   task = Task (done) @0x0000000174f71b60
│   reason = auto recovery
│   current_time = 2022-09-11T16:36:46.308-07:00
└ @ Discorder /Users/tomkwong/.julia/dev/Discorder/src/gateway.jl:420
┌ Info: Stopped task successfully
│   task_field = heartbeat_task
│   task = Task (done) @0x0000000174f71b60
│   current_time = 2022-09-11T16:36:46.308-07:00
└ @ Discorder /Users/tomkwong/.julia/dev/Discorder/src/gateway.jl:415
┌ Info: Finished doctor task
│   current_time = 2022-09-11T16:36:46.308-07:00
└ @ Discorder /Users/tomkwong/.julia/dev/Discorder/src/gateway.jl:257
┌ Info: Control plane is finished
│   current_time = 2022-09-11T16:36:46.437-07:00
└ @ Discorder /Users/tomkwong/.julia/dev/Discorder/src/gateway.jl:151</code></pre><p>And then it shows that it started a new control plane:</p><pre><code class="nohighlight hljs">┌ Info: Going to recover by starting a new control plane
│   current_time = 2022-09-11T16:36:47.443-07:00
└ @ Discorder /Users/tomkwong/.julia/dev/Discorder/src/gateway.jl:160</code></pre><p>The <code>shutdown</code> function can be used to shut down the control plane gracefully.</p><pre><code class="language-julia hljs">julia&gt; D.shutdown(tracker_ref[])
┌ Info: Stopping task
│   task_field = :processor_task
│   task = Task (runnable) @0x0000000108bb95a0
└   reason = &quot;graceful shutdown&quot;
┌ Info: Stopped task successfully
│   task_field = :processor_task
└   task = Task (done) @0x0000000108bb95a0
┌ Info: Stopping task
│   task_field = :heartbeat_task
│   task = Task (runnable) @0x0000000108bb9430
└   reason = &quot;graceful shutdown&quot;
┌ Info: Stopped task successfully
│   task_field = :heartbeat_task
└   task = Task (done) @0x0000000108bb9430</code></pre></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Monday 19 September 2022 00:09">Monday 19 September 2022</span>. Using Julia version 1.8.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
